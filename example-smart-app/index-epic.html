<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
    <title>Example-SMART-App Aziz</title>
    <link rel='stylesheet' type='text/css' href='./src/css/example-smart-app.css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
    <!--
    <link rel='stylesheet' type='text/css' href='./lib/css/cerner-smart-embeddable-lib-1.0.0.min.css'>
    -->
    <style>
      table th {
        white-space: nowrap
      }
    </style>
  </head>
  <body class='container-fluid' style="padding-left: 50px;padding-right: 50px">
    <div id='errors'>
    </div>
    <div id="loading" class="spinner">
      <div class="bounce1"></div>
      <div class="bounce2"></div>
      <div class="bounce3"></div>
    </div>
    <div id='holder' >
      <h2>Example-SMART-App</h2>

      <h2>Patient Resource</h2>
      <table>
        <tr>
          <th>First Name:</th>
          <td id='fname'></td>
        </tr>
        <tr>
          <th>Last Name:</th>
          <td id='lname'></td>
        </tr>
        <tr>
          <th>Gender:</th>
          <td id='gender'></td>
        </tr>
        <tr>
          <th>Date of Birth:</th>
          <td id='birthdate'></td>
        </tr>
        <tr>
          <th>Age:</th>
          <td id='age'></td>
        </tr>
      </table>
      <!--
      <h2>Observation Resource</h2>
      <table>
        <tr>
          <th>Height:</th>
          <td id='height'></td>
        </tr>
        <tr>
          <th>Systolic Blood Pressure:</th>
          <td id='systolicbp'></td>

        </tr>
        <tr>
          <th>Diastolic Blood Pressure:</th>
          <td id='diastolicbp'></td>
        </tr>
        <tr>
          <th>LDL:</th>
          <td id='ldl'></td>
        </tr>
        <tr>
          <th>HDL:</th>
          <td id='hdl'></td>
        </tr>
      </table>
      -->
    </div>
    <form id="searchForm" class="well" style="margin-top:10px">
    <label>Category: </label>
    <select id="category">
      <option value="">All</option>
      <option value="problem" selected>Problem</option>
      <option value="diagnosis">Diagnosis</option>
    </select>
    <label>Clinical Status: </label>
    <select id="status">
      <option value="">All</option>
      <option value="active" selected>Active</option>
      <option value="resolved">Resolved</option>
    </select>
    <input type="submit" style="display: none" />
    <input type="submit">
  </form>
  <table id="result" class="table display" width="100%">
  </table>
  
    <!-- Required JS files to enable this page to embed within an MPage -->
    <script src='https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.26.0/polyfill.min.js'></script>
    <!--
    <script src='./lib/js/cerner-smart-embeddable-lib-1.0.0.min.js'></script>
    --!>

    <!-- Application-level javascript-->
    <script src='./src/js/example-smart-app.js'></script>

    <!-- FHIR Client JS Library -->
    <script src='./lib/js/fhir-client-v0.1.12.js'></script>

    <!-- Prevent session bleed caused by single threaded embedded browser and sessionStorage API -->
    <!-- https://github.com/cerner/fhir-client-cerner-additions -->
    <script src='./lib/js/fhir-client-cerner-additions-1.0.0.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>
      var open = XMLHttpRequest.prototype.open;
      extractData().then(
        //Display Patient Demographics and Observations if extractData was success
        function(p) {
          drawVisualization(p);
        },
        //Display 'Failed to call FHIR Service' if extractData failed
        function() {
          $('#loading').hide();
          $('#errors').html('<p> Failed to call FHIR Service </p>');
        }
      );
    function RefreshToken() {
      FHIR.oauth2.ready(
        function (smart) {
          window.smart = smart;
          console.info('Token refreshed.')
        },
        function () {
          console.error('Error while refreshing token.');
        }
      );
    }

    $('#searchForm').on('submit',
      function (e) {
        e.preventDefault();
        let category = $("#category").val()
        let status = $("#status").val()
        Search(category, status);
      });

    function Search(category, status) {
      //condition
      let searchParameters = {
        type: 'Condition',
        query: {
          patient: smart.patient.id,
        }
      };
      if (category) {
        searchParameters.query.category = category;
      };
      if (status) {
        searchParameters.query.clinicalstatus = status
      };
      //
      smart.api.search(searchParameters).then(
        function (conditions) {
          window.conditions = conditions;
          console.log(conditions);
          conditions.data.entry.forEach(element => {
            element.cancelLink = '<button onclick=\'DeleteCondition("'+element.resource.id+'")\'>Delete</button>';
            element.resolveLink = '<button onclick=\'ResolveCondition("'+element.resource.id+'")\'>Resolve</button>';
          });
          $('#result').DataTable({
            "destroy": true,
            "searching": true,
            "pageLength": 50,
            "autoWidth": true,
            "order": [[4, 'desc']],
            "lengthMenu": [[50, 200, -1], [50, 200, "All"]],
            "data": conditions.data.entry,
            "columns": [
              { "data": "resource.id", "title": "#" },
              { "data": "resource.code.text", "title": "Title" },
              { "data": "resource.category.text", "title": "Category" },
              { "data": "resource.clinicalStatus", "title": "Clinical Status", "defaultContent": "" },
              { "data": "resource.meta.lastUpdated", "title": "Last Updated"},
              { "data": "resource.verificationStatus", "title": "Verification Status" },
              { "data": "resource.dateRecorded", "title": "Recorded Date" },
              { "data": "cancelLink", "title": "" },
              { "data": "resolveLink", "title": "" }
            ]
          });;
        }
      )
    }

    function DeleteCondition(id) {
      let entries = conditions.data.entry;
      let index = entries.findIndex(x => x.resource.id == id);
      if (index >= 0) {
        let condition = entries[index].resource;
        condition.verificationStatus = "entered-in-error";
        //
        XMLHttpRequest.prototype.open = function () {
          var res = open.apply(this, arguments);
          this.setRequestHeader('If-Match', 'W/"'+ condition.meta.versionId +'"');
          return res;
        }
        //
        smart.api.update({ resource: condition }).then(
          function (r) {
            console.log('"' + condition.code.text + '" has been deleted!');
            alert('"' + condition.code.text + '" has been deleted!')
          },        
          function (error) {            
            console.log("delete condtion failed");
            console.log(error);
          }
        );
      }
    }

    function ResolveCondition(id) {
      let entries = conditions.data.entry;
      let index = entries.findIndex(x => x.resource.id == id);      
      if (index >= 0) {
        smart.patient.condition.open()

        let condition = entries[index].resource;
        condition.clinicalStatus = "resolved";
        //        
        XMLHttpRequest.prototype.open = function () {
          var res = open.apply(this, arguments);
          this.setRequestHeader('If-Match', 'W/"'+ condition.meta.versionId +'"');
          return res;
        }
        //
        smart.api.update({ resource: condition }).done(function (r) {
          alert('"' + condition.code.text + '" has been resolved!');
        }).fail(function(error){
          console.log(error);
        });
      }
    }

    function AddProblem(text, snomedCode, snomedTitle) {
      let resource = {
        "resourceType": "Condition",
        "patient": {
          "reference": "Patient/" + smart.patient.id
        },
        "code": {
          "coding": [{
            "system": "http://snomed.info/sct",
            "code": snomedCode,
            "display": snomedTitle,
          }
          ],
          "text": text,
        },
        "clinicalStatus": "active",
        "verificationStatus": "confirmed"
      };
      smart.api.create({ resource: resource }).done(function (r) {
        console.log("problem added!");
      });
    }
    </script>
  </body>
</html>
